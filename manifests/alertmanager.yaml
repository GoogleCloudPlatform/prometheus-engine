# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# kubectl create secret generic alertmanager \
#  -n gmp-public \
#  --from-file=./manifests/alertmanager.yaml
# as per https://cloud.google.com/stackdriver/docs/managed-prometheus/rules-managed#am-config-managed
global:
  resolve_timeout: 5m
  slack_api_url: https://slack.com/api/chat.postMessage

inhibit_rules:
- equal:
  - namespace
  - alertname
  source_matchers:
  - severity = critical
  target_matchers:
  - severity =~ warning|error|info
- equal:
  - namespace
  - alertname
  source_matchers:
  - severity = error
  target_matchers:
  - severity = warning|info
- equal:
  - namespace
  - alertname
  source_matchers:
  - severity = warning
  target_matchers:
  - severity = info
- equal:
  - namespace
  source_matchers:
  - alertname = InfoInhibitor
  target_matchers:
  - severity = info
- target_matchers:
  - alertname = InfoInhibitor

receivers:
- name: "null"
- name: incident.io
  webhook_configs:
  - url: 'https://api.incident.io/v2/alert_events/alertmanager/xxxx'
    send_resolved: true
    http_config:
      authorization:
        credentials: xxxx

- name: slack
  slack_configs:
  - channel: monitoring-non_prod
    http_config:
      authorization:
        credentials: xoxb-xxxx
    send_resolved: true
    title: >
      {{- if eq .Status "firing" -}}:exclamation: {{ .CommonLabels.project_id }} {{ .CommonLabels.severity | toUpper }} {{ .CommonLabels.alertname }}
      {{- else -}}:heavy_check_mark: {{ .CommonLabels.project_id }} {{ .CommonLabels.severity | toUpper }} {{ .CommonLabels.alertname }}
      {{- end -}}
    text: >
      {{- range .Alerts -}}
        {{"\n"}}
        {{- if .Annotations.summary }}{{ .Annotations.summary }}{{"\n"}}{{ end -}}
        {{- if .Annotations.message }}{{ .Annotations.message }}{{"\n"}}{{ end -}}
        {{- if .Annotations.description }}{{ .Annotations.description }}{{"\n"}}{{ end -}}
      {{- end -}}
      {{"\n"}}
      {{- if .CommonLabels.team }}*team*: {{ .CommonLabels.team }}{{"\n"}}{{ end -}}
      {{- if .CommonLabels.namespace }}*ns*: {{ .CommonLabels.namespace }}{{"\n"}}{{ end -}}
      {{- if .CommonLabels.pod }}*pod*: {{ .CommonLabels.pod }}{{"\n"}}{{ end -}}
      {{- if .CommonLabels.app }}*app*: {{ .CommonLabels.app }}{{"\n"}}{{ end -}}
      {{- if .CommonLabels.name }}*name*: {{ .CommonLabels.name }}{{"\n"}}{{ end -}}
      {{- if .CommonLabels.domain }}*domain*: {{ .CommonLabels.domain }}{{"\n"}}{{ end -}}

- name: slack_argo
  slack_configs:
  - channel: monitoring-non_prod
    http_config:
      authorization:
        credentials: xoxb-xxxx
    send_resolved: true
    title: >
      {{- if eq .Status "firing" -}}:exclamation: {{ .CommonLabels.project_id }} {{ .CommonLabels.severity | toUpper }} {{ .CommonLabels.alertname }}
      {{- else -}}:heavy_check_mark: {{ .CommonLabels.project_id }} {{ .CommonLabels.severity | toUpper }} {{ .CommonLabels.alertname }}
      {{- end -}}
    text: >
      {{- range .Alerts -}}
        {{"\n"}}
        {{- if .Annotations.summary }}{{ .Annotations.summary }}{{"\n"}}{{ end -}}
        {{- if .Annotations.message }}{{ .Annotations.message }}{{"\n"}}{{ end -}}
        {{- if .Annotations.description }}{{ .Annotations.description }}{{"\n"}}{{ end -}}
      {{- end -}}
      {{"\n"}}

- name: slack_airflow
  slack_configs:
  - channel: monitoring-airflow-xxxx-sandbox
    http_config:
      authorization:
        credentials: xoxb-xxxx
    send_resolved: true
    title: >
      {{- if eq .Status "firing" -}}:exclamation: {{ .CommonLabels.project_id }} {{ .CommonLabels.severity | toUpper }} {{ .CommonLabels.alertname }}
      {{- else -}}:heavy_check_mark: {{ .CommonLabels.project_id }} {{ .CommonLabels.severity | toUpper }} {{ .CommonLabels.alertname }}
      {{- end -}}
    text: >
      {{- range .Alerts -}}
        {{"\n"}}
        {{- if .Annotations.summary }}{{ .Annotations.summary }}{{"\n"}}{{ end -}}
        {{- if .Annotations.message }}{{ .Annotations.message }}{{"\n"}}{{ end -}}
        {{- if .Annotations.description }}{{ .Annotations.description }}{{"\n"}}{{ end -}}
      {{- end -}}
      {{"\n"}}

route:
  group_by:
  - alertname
  - cluster
  - service
  group_interval: 10m
  group_wait: 60s
  receiver: "null"
  repeat_interval: 3h
  routes:
  - receiver: incident.io
    match_re:
      severity: warning|critical|error
    continue: true
  - match:
      namespace: airflow
    receiver: slack_airflow
  - match:
      service: xxxx
    receiver: slack_airflow
  - match:
      job: argocd-application-controller-metrics
    receiver: slack_argo
  - match_re:
      severity: warning|error|critical
    receiver: slack
